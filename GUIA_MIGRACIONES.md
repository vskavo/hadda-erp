# üìö Gu√≠a de Migraciones de Base de Datos

Esta gu√≠a explica c√≥mo manejar cambios en el esquema de base de datos sin afectar los datos de los clientes.

---

## üîÑ C√≥mo Funciona el Sistema

### Flujo Autom√°tico en Deployment

Cuando despliegas o reinicias un contenedor, el sistema ejecuta autom√°ticamente:

```
1. Esperar a que la BD est√© lista
2. Sincronizar esquema base (crear tablas si no existen)
3. ‚ú® EJECUTAR MIGRACIONES PENDIENTES ‚ú®
4. ‚ú® EJECUTAR SEEDERS DE DATOS INICIALES ‚ú®  ‚Üê NUEVO
5. Crear rol administrador y permisos
6. Crear usuario admin (si no existe)
7. Iniciar aplicaci√≥n
```

### ¬øQu√© son los Seeders?

Los **seeders** insertan datos iniciales necesarios para que la aplicaci√≥n funcione correctamente:

- **Informes Predefinidos**: 6 templates de reportes listos para usar (Proyectos Activos, Clientes Activos, Facturas Pendientes, Ventas del Mes, Cursos Activos, Resumen Financiero)
- Otros datos de configuraci√≥n del sistema que se agregar√°n en el futuro

Los seeders son **idempotentes** - verifican si los datos ya existen antes de insertarlos, por lo que es seguro ejecutarlos m√∫ltiples veces.

### Tabla de Control

Sequelize mantiene una tabla `SequelizeMeta` que registra qu√© migraciones ya se ejecutaron:

```sql
SELECT * FROM "SequelizeMeta";
```

```
name
-----------------------------
20240601000001-create-sesiones.js
20240601000002-create-asistencias.js
20240601000003-add-porcentaje-asistencia-to-participantes.js
...
```

**Esto garantiza que cada migraci√≥n se ejecute UNA SOLA VEZ**, incluso si reinicias el contenedor m√∫ltiples veces.

---

## üõ†Ô∏è Crear Nueva Migraci√≥n

### Opci√≥n 1: Comando Sequelize CLI (Recomendado)

```bash
# En el directorio backend/
cd backend

# Crear una nueva migraci√≥n
npx sequelize-cli migration:generate --name add-telefono-to-usuarios
```

Esto crea un archivo: `backend/migrations/YYYYMMDDHHMMSS-add-telefono-to-usuarios.js`

### Opci√≥n 2: Crear archivo manualmente

Crea un archivo en `backend/migrations/` con el formato:

```
YYYYMMDDHHMMSS-descripcion-del-cambio.js
```

Ejemplo: `20251004120000-add-telefono-to-usuarios.js`

---

## ‚úçÔ∏è Estructura de una Migraci√≥n

```javascript
'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface, Sequelize) {
    // CAMBIOS A APLICAR (cuando se ejecuta la migraci√≥n)
    
    // Ejemplo 1: Agregar una columna
    await queryInterface.addColumn('usuarios', 'telefono', {
      type: Sequelize.STRING(20),
      allowNull: true,
      comment: 'Tel√©fono de contacto del usuario'
    });
    
    // Ejemplo 2: Agregar un √≠ndice
    await queryInterface.addIndex('usuarios', ['telefono'], {
      name: 'idx_usuarios_telefono'
    });
  },

  async down(queryInterface, Sequelize) {
    // ROLLBACK (c√≥mo revertir los cambios si es necesario)
    
    await queryInterface.removeIndex('usuarios', 'idx_usuarios_telefono');
    await queryInterface.removeColumn('usuarios', 'telefono');
  }
};
```

---

## üìù Ejemplos Comunes de Migraciones

### Agregar una columna

```javascript
async up(queryInterface, Sequelize) {
  await queryInterface.addColumn('proyectos', 'codigo_interno', {
    type: Sequelize.STRING(50),
    allowNull: true,
    unique: true
  });
}

async down(queryInterface, Sequelize) {
  await queryInterface.removeColumn('proyectos', 'codigo_interno');
}
```

### Modificar tipo de columna

```javascript
async up(queryInterface, Sequelize) {
  await queryInterface.changeColumn('usuarios', 'email', {
    type: Sequelize.STRING(255),
    allowNull: false,
    unique: true
  });
}

async down(queryInterface, Sequelize) {
  await queryInterface.changeColumn('usuarios', 'email', {
    type: Sequelize.STRING(100),
    allowNull: false,
    unique: true
  });
}
```

### Crear una tabla nueva

```javascript
async up(queryInterface, Sequelize) {
  await queryInterface.createTable('notificaciones', {
    id: {
      type: Sequelize.INTEGER,
      primaryKey: true,
      autoIncrement: true
    },
    usuario_id: {
      type: Sequelize.INTEGER,
      allowNull: false,
      references: {
        model: 'usuarios',
        key: 'id'
      },
      onDelete: 'CASCADE'
    },
    mensaje: {
      type: Sequelize.TEXT,
      allowNull: false
    },
    leida: {
      type: Sequelize.BOOLEAN,
      defaultValue: false
    },
    created_at: {
      type: Sequelize.DATE,
      allowNull: false
    },
    updated_at: {
      type: Sequelize.DATE,
      allowNull: false
    }
  });
}

async down(queryInterface, Sequelize) {
  await queryInterface.dropTable('notificaciones');
}
```

### Agregar √≠ndice compuesto

```javascript
async up(queryInterface, Sequelize) {
  await queryInterface.addIndex('proyectos', ['cliente_id', 'estado'], {
    name: 'idx_proyectos_cliente_estado'
  });
}

async down(queryInterface, Sequelize) {
  await queryInterface.removeIndex('proyectos', 'idx_proyectos_cliente_estado');
}
```

### Migraci√≥n de datos (UPDATE/INSERT)

```javascript
async up(queryInterface, Sequelize) {
  // Agregar columna
  await queryInterface.addColumn('usuarios', 'timezone', {
    type: Sequelize.STRING(50),
    allowNull: true
  });
  
  // Poblar con valor por defecto para usuarios existentes
  await queryInterface.sequelize.query(`
    UPDATE usuarios 
    SET timezone = 'America/Santiago' 
    WHERE timezone IS NULL
  `);
  
  // Hacer la columna NOT NULL ahora que tiene datos
  await queryInterface.changeColumn('usuarios', 'timezone', {
    type: Sequelize.STRING(50),
    allowNull: false,
    defaultValue: 'America/Santiago'
  });
}

async down(queryInterface, Sequelize) {
  await queryInterface.removeColumn('usuarios', 'timezone');
}
```

---

## üöÄ Flujo Completo de Deployment con Migraci√≥n

### Escenario: Necesitas agregar la columna `telefono` a la tabla `usuarios`

#### 1. **Desarrollo Local**

```bash
# Crear la migraci√≥n
cd backend
npx sequelize-cli migration:generate --name add-telefono-to-usuarios

# Editar el archivo generado en backend/migrations/
# Agregar la l√≥gica de up() y down()

# Probar la migraci√≥n localmente
npx sequelize-cli db:migrate

# Verificar que funcion√≥
npx sequelize-cli db:migrate:status
```

#### 2. **Actualizar el Modelo (Opcional pero recomendado)**

Si agregaste una columna, actualiza el modelo de Sequelize:

```javascript
// backend/models/usuario.model.js
const Usuario = sequelize.define('Usuario', {
  // ... campos existentes ...
  telefono: {
    type: DataTypes.STRING(20),
    allowNull: true
  }
});
```

#### 3. **Commit y Push**

```bash
git add backend/migrations/20251004120000-add-telefono-to-usuarios.js
git add backend/models/usuario.model.js
git commit -m "feat: Add telefono field to usuarios table"
git push origin main
```

#### 4. **GitHub Actions Build**

- GitHub Actions construye autom√°ticamente la nueva imagen Docker
- La imagen incluye la nueva migraci√≥n en `backend/migrations/`
- Espera ~2-3 minutos a que termine el build

#### 5. **Actualizar Clientes**

##### Opci√≥n A: Actualizar UN cliente espec√≠fico

```bash
# El script reinicia el Web App y pull la imagen :latest
./scripts/update-webapp.sh cliente-prueba
```

##### Opci√≥n B: Actualizar TODOS los clientes

```bash
# Reinicia todos los Web Apps para que pull la imagen :latest
./scripts/update-all-webapps.sh
```

#### 6. **Verificar en los Logs**

```bash
az webapp log tail \
  --resource-group hadda-clientes-rg \
  --name hadda-erp-cliente-prueba
```

Deber√≠as ver:

```
=== Ejecutando Migraciones de Sequelize ===
‚úì Directorio de migraciones encontrado
‚úì Total de archivos de migraci√≥n disponibles: 14
‚úì Ejecutando migraciones pendientes...
  Sequelize CLI [Node: 22.x.x, CLI: 6.x.x, ORM: 6.x.x]
  
  Loaded configuration file "config/config.js".
  Using environment "production".
  
  == 20251004120000-add-telefono-to-usuarios: migrating =======
  == 20251004120000-add-telefono-to-usuarios: migrated (0.125s)
  
‚úì Migraciones ejecutadas exitosamente
```

#### 7. **Verificar en Supabase**

```sql
-- Verificar que la columna existe
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'usuarios' AND column_name = 'telefono';

-- Verificar que la migraci√≥n est√° registrada
SELECT * FROM "SequelizeMeta" WHERE name = '20251004120000-add-telefono-to-usuarios.js';
```

---

## ‚ö†Ô∏è Mejores Pr√°cticas

### ‚úÖ DO (Hacer)

1. **Siempre escribe el m√©todo `down()`** para poder revertir cambios si es necesario
2. **Prueba localmente primero** antes de deployar a producci√≥n
3. **Usa transacciones** para cambios complejos que deben ser at√≥micos
4. **Nombra descriptivamente** las migraciones: `add-X-to-Y`, `create-table-Z`, `fix-column-type-W`
5. **Documenta cambios complejos** con comentarios en la migraci√≥n
6. **Considera datos existentes** al agregar columnas NOT NULL (usa valores por defecto)

### ‚ùå DON'T (No hacer)

1. **NO modifiques migraciones ya ejecutadas** - Crea una nueva migraci√≥n para corregir
2. **NO uses `sequelize.sync({ alter: true })`** en producci√≥n - Puede perder datos
3. **NO borres la tabla `SequelizeMeta`** - Perder√°s el historial de qu√© migraciones ya se ejecutaron
4. **NO hagas cambios destructivos sin backup** (DROP TABLE, DROP COLUMN con datos importantes)
5. **NO dependas de datos espec√≠ficos del ambiente** en las migraciones

---

## üêõ Troubleshooting

### La migraci√≥n ya se ejecut√≥ pero quiero re-ejecutarla

```bash
# En desarrollo local:
cd backend
npx sequelize-cli db:migrate:undo

# O revertir todas:
npx sequelize-cli db:migrate:undo:all
```

### Error: "Migration X has already been executed"

Esto es normal. Sequelize detect√≥ que la migraci√≥n ya se aplic√≥ y la salt√≥. No es un error.

### Necesito ejecutar una migraci√≥n manualmente en Supabase

```sql
-- 1. Ejecuta el SQL de la migraci√≥n directamente
ALTER TABLE usuarios ADD COLUMN telefono VARCHAR(20);

-- 2. Registra la migraci√≥n como ejecutada
INSERT INTO "SequelizeMeta" (name) 
VALUES ('20251004120000-add-telefono-to-usuarios.js');
```

### La migraci√≥n fall√≥ a medias

Si una migraci√≥n falla parcialmente:

1. **Verifica el estado en Supabase** - ¬øSe aplicaron algunos cambios?
2. **Ejecuta el `down()` manualmente** si es necesario limpiar
3. **Corrige la migraci√≥n** y crea una nueva con sufijo `-fix`
4. **NO modifiques la migraci√≥n original** que ya est√° en `SequelizeMeta`

---

## üìä Comandos √ötiles

```bash
# Ver estado de migraciones
cd backend
npx sequelize-cli db:migrate:status

# Ejecutar migraciones pendientes
npx sequelize-cli db:migrate

# Revertir √∫ltima migraci√≥n
npx sequelize-cli db:migrate:undo

# Revertir hasta una migraci√≥n espec√≠fica
npx sequelize-cli db:migrate:undo:all --to 20240601000003-add-porcentaje-asistencia-to-participantes.js
```

---

## üéØ Resumen del Flujo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Desarrollador                                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ 1. Crear migraci√≥n con sequelize-cli                   ‚îÇ
‚îÇ 2. Probar localmente                                    ‚îÇ
‚îÇ 3. Actualizar modelo (si aplica)                       ‚îÇ
‚îÇ 4. git commit & push                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  GitHub Actions                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Build Docker image con nueva migraci√≥n               ‚îÇ
‚îÇ ‚Ä¢ Push a ghcr.io con tag :latest                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Actualizar Clientes                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ ./scripts/update-webapp.sh cliente-X                 ‚îÇ
‚îÇ ‚Ä¢ O ./scripts/update-all-webapps.sh                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Azure Web App (Cada Cliente)                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Reinicia y pull imagen :latest                       ‚îÇ
‚îÇ ‚Ä¢ docker-entrypoint.sh ejecuta:                        ‚îÇ
‚îÇ   - Espera BD ready                                    ‚îÇ
‚îÇ   - Sync esquema base                                  ‚îÇ
‚îÇ   - ‚ú® Ejecuta migraciones pendientes ‚ú®              ‚îÇ
‚îÇ   - Crea admin si no existe                            ‚îÇ
‚îÇ   - Inicia app                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Base de Datos (Supabase)                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‚Ä¢ Registra migraci√≥n en SequelizeMeta                  ‚îÇ
‚îÇ ‚Ä¢ Esquema actualizado ‚úÖ                               ‚îÇ
‚îÇ ‚Ä¢ Datos preservados ‚úÖ                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê Seguridad de Datos

El sistema de migraciones es **seguro** porque:

1. ‚úÖ **Sequelize CLI usa transacciones** - Si algo falla, se revierte todo
2. ‚úÖ **Cada migraci√≥n se ejecuta UNA VEZ** - Registrado en `SequelizeMeta`
3. ‚úÖ **No usa `sequelize.sync({ force: true })`** - NO borra tablas existentes
4. ‚úÖ **Las migraciones son revisables** - Est√°n en Git, puedes auditar cambios
5. ‚úÖ **Puedes revertir** - El m√©todo `down()` permite rollback

**Recomendaci√≥n**: Siempre ten backups de Supabase antes de desplegar cambios cr√≠ticos.

---

## üå± Crear Nuevos Seeders

Si necesitas agregar otros datos iniciales (ej: categor√≠as, configuraciones, etc.), sigue este patr√≥n:

### 1. Crear el archivo del seeder

```javascript
// backend/scripts/seed-categorias.js
require('dotenv').config();
const { sequelize, Categoria } = require('../models');

async function seedCategorias() {
  try {
    console.log('üå± Creando categor√≠as iniciales...');
    
    await sequelize.authenticate();
    
    const categorias = [
      { nombre: 'Capacitaci√≥n', activo: true, sistema: true },
      { nombre: 'Consultor√≠a', activo: true, sistema: true },
      { nombre: 'Asesor√≠a', activo: true, sistema: true }
    ];
    
    for (const categoriaData of categorias) {
      // Verificar si ya existe
      const existe = await Categoria.findOne({
        where: { nombre: categoriaData.nombre }
      });
      
      if (!existe) {
        await Categoria.create(categoriaData);
        console.log(`‚úì Categor√≠a creada: ${categoriaData.nombre}`);
      } else {
        console.log(`‚ö†Ô∏è  Categor√≠a ya existe: ${categoriaData.nombre}`);
      }
    }
    
    console.log('‚úì Categor√≠as iniciales creadas');
    await sequelize.close();
    
  } catch (error) {
    console.error('‚ùå Error al crear categor√≠as:', error);
    process.exit(1);
  }
}

// Ejecutar solo si se llama directamente
if (require.main === module) {
  seedCategorias();
}

module.exports = seedCategorias;
```

### 2. Agregar al docker-entrypoint.sh

Edita la funci√≥n `seed_initial_data()`:

```bash
seed_initial_data() {
    echo ""
    echo "=== Ejecutando Seeders de Datos Iniciales ==="
    
    # Seeder de informes predefinidos
    if [ -f "backend/scripts/crear-templates-reportes.js" ]; then
        echo "‚úì Ejecutando seeder de informes predefinidos..."
        node backend/scripts/crear-templates-reportes.js
    fi
    
    # Seeder de categor√≠as (NUEVO)
    if [ -f "backend/scripts/seed-categorias.js" ]; then
        echo "‚úì Ejecutando seeder de categor√≠as..."
        node backend/scripts/seed-categorias.js
    fi
    
    echo ""
}
```

### 3. Probar localmente

```bash
node backend/scripts/seed-categorias.js
```

### 4. Commit y deploy

```bash
git add backend/scripts/seed-categorias.js docker-entrypoint.sh
git commit -m "feat: Add categorias seeder"
git push origin main
```

---

## üìû ¬øPreguntas?

Si algo no est√° claro o encuentras un caso de uso no documentado, actualiza esta gu√≠a! üöÄ

